<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>新手到進階學 MongoDB（3）- Aggregation 教學 | Suki&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">




<meta name="description" content="後端工程師的軟體開發、學習筆記">



<meta name="keywords" content="mongodb,database,教學,tutorial,aggregate">



    <meta name="description" content="本篇文章是系列文新手到進階學 MongoDB 的第三篇，要介紹 MongoDB 中較進階的 Aggregation 用法。 文章的架構如下：  Aggregation 基本概念：什麼是 Pipeline 與 Stage ？ 常見的資料操作方法（ㄧ）：$match、$sort、$limit 常見的資料操作方法（二）$project、$group、$unwind Aggregation 綜合練習  你">
<meta property="og:type" content="article">
<meta property="og:title" content="新手到進階學 MongoDB（3）- Aggregation 教學">
<meta property="og:url" content="https://www.suki.website/mongodb-from-scratch/3/">
<meta property="og:site_name" content="Suki&#39;s blog">
<meta property="og:description" content="本篇文章是系列文新手到進階學 MongoDB 的第三篇，要介紹 MongoDB 中較進階的 Aggregation 用法。 文章的架構如下：  Aggregation 基本概念：什麼是 Pipeline 與 Stage ？ 常見的資料操作方法（ㄧ）：$match、$sort、$limit 常見的資料操作方法（二）$project、$group、$unwind Aggregation 綜合練習  你">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://www.suki.website/og-256x256.png">
<meta property="article:published_time" content="2021-07-28T06:17:41.000Z">
<meta property="article:modified_time" content="2021-08-29T14:33:02.054Z">
<meta property="article:author" content="Suki Wang">
<meta property="article:tag" content="mongodb">
<meta property="article:tag" content="database">
<meta property="article:tag" content="mongodb-from-scratch">
<meta property="article:tag" content="mongodb 教學">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.suki.website/og-256x256.png">





<link rel="icon" href="/favicon-32x32.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">



<script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=60f8d93619c5120013482fe3&amp;product=inline-share-buttons' async='async'></script>


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/styles/lioshi.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H1DHN5Q7LQ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H1DHN5Q7LQ');
</script>


    


<meta name="generator" content="Hexo 5.4.2"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    Suki
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/categories/technology">技術分享</a>
            
            <a class="navbar-item "
               href="/categories/life">生活雜記</a>
            
            <a class="navbar-item "
               href="/categories">文章列表</a>
            
            <a class="navbar-item "
               href="/about">關於我</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜尋" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" title="GitHub" target="_blank" rel="noopener" href="https://github.com/pmc12thsuki">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            新手到進階學 MongoDB（3）- Aggregation 教學
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        
        <span class="column is-narrow">
            
                <time datetime="2021-07-28T06:17:41.000Z" itemprop="datePublished">7月 28 2021</time>
            
        </span>
        
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/technology/">technology</a><span>></span><a class="article-category-link" href="/categories/technology/database/">database</a>
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>本篇文章是系列文<a href="/tags/mongodb-from-scratch/">新手到進階學 MongoDB</a> 的第三篇，要介紹 MongoDB 中較進階的 Aggregation 用法。</p>
<p>文章的架構如下：</p>
<ul>
<li>Aggregation 基本概念：什麼是 Pipeline 與 Stage ？</li>
<li>常見的資料操作方法（ㄧ）：<code>$match</code>、<code>$sort</code>、<code>$limit</code></li>
<li>常見的資料操作方法（二）<code>$project</code>、<code>$group</code>、<code>$unwind</code></li>
<li>Aggregation 綜合練習</li>
</ul>
<p>你也可以在上一篇文章中複習 <a href="/mongodb-from-scratch/2/">MongoDB 的 CRUD 操作</a>。</p>
<span id="more"></span>

<h2 id="Aggregation-基本概念"><a href="#Aggregation-基本概念" class="headerlink" title="Aggregation 基本概念"></a>Aggregation 基本概念</h2><p>MongoDB 的<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/aggregation/">文件</a>裡寫到：</p>
<blockquote>
<p>Aggregation operations process data records and return computed results.</p>
</blockquote>
<p>意思是：<code>Aggregation</code>是幫助我們在 MongoDB server 端進行「資料處理」的工具。</p>
<p>你可能會好奇在 MongoDB server 端進行資料處理的好處是什麼？為什麼不在應用程式端處理就好？<br>舉個例子，假如我們有一個名為 <code>products</code>的 collection，裡頭裡存放了所有商品的資訊。當我們想要知道「最貴的商品是什麼」時，我們有兩種做法：</p>
<ol>
<li>把所有的商品都查詢出來，再在應用程式中找出價錢最高的商品</li>
<li>透過撰寫 Aggregation 指令，直接在 MongoDB server 端找出價錢最高的商品</li>
</ol>
<p>可以看出資料量龐大時，比起把所有資料都拿回應用程式端做處理，使用 Aggregation 更有效率些～</p>
<h3 id="什麼是-Pipeline-跟-Stage"><a href="#什麼是-Pipeline-跟-Stage" class="headerlink" title="什麼是 Pipeline 跟 Stage"></a>什麼是 Pipeline 跟 Stage</h3><p>如果我們把「資料處理」比喻成「罐頭加工」的過程，那麼：</p>
<ul>
<li>存在 mongoDB 中的原始資料就是「罐頭的原物料」</li>
<li><code>Pipeline</code>是罐頭加工廠的「生產線」</li>
<li><code>Stage</code>是生產線中的「一道手續」</li>
</ul>
<p>我們透過描述一連串的 stages (手續)來組成 pipeline（生產線），並對原始資料（原物料）進行 aggregate（加工），最終變成我們想要的成果（罐頭）。如同生產線中手續的「優先順序」很重要一樣，pipeline 中 stages 的順序是很重要的，因為每一個 stage 的 input 都是上一個 stage 處理後的 output。</p>
<p>舉例來說，我們可以透過由兩個 stage 組成的 pipeline 找出資料庫中「最貴的科技商品」是什麼。要注意兩個 stage 的順序不能調換：</p>
<figure class="highlight js hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 針對 products collection 使用 aggregate</span></span><br><span class="line">db.<span class="hljs-property">products</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">   找出所有「科技類」商品, <span class="hljs-comment">// 第一個 stage</span></span><br><span class="line">   找到其中「價錢最高」的商品 <span class="hljs-comment">// 第二個 stage</span></span><br><span class="line">])</span><br></pre></td></tr></tbody></table></figure>

<p>再來我們會介紹幾個常見的 stage 以及應用方法。</p>
<h2 id="常見的資料操作方法（ㄧ）"><a href="#常見的資料操作方法（ㄧ）" class="headerlink" title="常見的資料操作方法（ㄧ）"></a>常見的資料操作方法（ㄧ）</h2><p>首先要介紹<code>$match</code>、<code>$sort</code>、<code>$limit</code>這三個方法。</p>
<h3 id="match"><a href="#match" class="headerlink" title="$match"></a><code>$match</code></h3><p>用來找出符合需求條件的資料。用法就跟<a href="/mongodb-from-scratch/2/">上一篇</a>介紹的<code>find</code>很像，是最常用到 Aggregation 方法之一。</p>
<p>假如有一個<code>articles</code>collection 資料如下：</p>
<figure class="highlight json hljs"><figcaption><span>articles</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"dave"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">80</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">100</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"512bc95fe835e68f199c8686"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"dave"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">85</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">521</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"512bc962e835e68f199c8687"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"ahn"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"55f5a192d4bede9ac365b257"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"li"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">55</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"55f5a192d4bede9ac365b258"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"annT"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">50</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"55f5a1d3d4bede9ac365b259"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"li"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">94</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">999</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"55f5a1d3d4bede9ac365b25a"</span>) <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"author"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"ty"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"score"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">95</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"views"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> ObjectId(<span class="hljs-string">"55f5a1d3d4bede9ac365b25b"</span>) <span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>我們可以用<code>$match</code>方法找出「作者是 dave」 的文章：</p>
<figure class="highlight js hljs"><figcaption><span>example-1</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 針對 articles collection 使用 aggregate</span></span><br><span class="line">db.<span class="hljs-property">articles</span>.<span class="title function_">aggregate</span>(</span><br><span class="line">    <span class="hljs-comment">// 只有一個 $match stage 的 pipeline</span></span><br><span class="line">    [ { $match : { author : <span class="hljs-string">"dave"</span> } } ]</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<p>會得出 2 筆結果</p>
<figure class="highlight js hljs"><figcaption><span>example-1-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"dave"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">80</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">100</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"512bc95fe835e68f199c8686"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"dave"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">85</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">521</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"512bc962e835e68f199c8687"</span>) }</span><br></pre></td></tr></tbody></table></figure>

<h4 id="搭配邏輯符號"><a href="#搭配邏輯符號" class="headerlink" title="搭配邏輯符號"></a>搭配邏輯符號</h4><p>在使用<code>$match</code>時也常搭配上邏輯符號，如<code>$or</code>、<code>$gt</code>、<code>$lt</code>，能夠更精準的描述想要的資料。</p>
<p>下面的範例在<code>articles</code>collection 中找出「分數大於 80、小於 95」或「觀看次數大於（等於） 1000」的文章：</p>
<figure class="highlight js hljs"><figcaption><span>example-2</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">articles</span>.<span class="title function_">aggregate</span>( [</span><br><span class="line">  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">$or</span>: [ { <span class="hljs-attr">score</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">$lt</span>: <span class="hljs-number">95</span> } }, { <span class="hljs-attr">views</span>: { <span class="hljs-attr">$gte</span>: <span class="hljs-number">1000</span> } } ] } },</span><br><span class="line">] );</span><br></pre></td></tr></tbody></table></figure>

<p>會得出 5 筆結果</p>
<figure class="highlight js hljs"><figcaption><span>example-2-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"dave"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">85</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">521</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"512bc962e835e68f199c8687"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"ahn"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">60</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">1000</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a192d4bede9ac365b257"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"li"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">55</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">5000</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a192d4bede9ac365b258"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"li"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">94</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">999</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a1d3d4bede9ac365b25a"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"ty"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">95</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">1000</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a1d3d4bede9ac365b25b"</span>) }</span><br></pre></td></tr></tbody></table></figure>


<h3 id="sort與-limit"><a href="#sort與-limit" class="headerlink" title="$sort與$limit"></a><code>$sort</code>與<code>$limit</code></h3><p><code>$sort</code>用來將 documents 依據指定欄位排序，<code>$limit</code>則是限定 documents 的數量。<br>這兩個 stage 常常搭配在一起使用。</p>
<p>同樣以上面<code>articles</code>collection 為例子，我們可以用<code>$sort</code>與<code>$limit</code>找出「分數最高的三篇文章」：</p>
<figure class="highlight js hljs"><figcaption><span>example-3</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">articles</span>.<span class="title function_">aggregate</span>( [</span><br><span class="line">  <span class="hljs-comment">// 依照分數「由高而低」排序</span></span><br><span class="line">  {<span class="hljs-string">"$sort"</span>: {</span><br><span class="line">    <span class="hljs-string">"score"</span>: -<span class="hljs-number">1</span>,</span><br><span class="line">  }},</span><br><span class="line">  <span class="hljs-comment">// 只要分數「前三高」的 document</span></span><br><span class="line">  {<span class="hljs-string">"$limit"</span>: <span class="hljs-number">3</span>}</span><br><span class="line">] );</span><br></pre></td></tr></tbody></table></figure>

<p>會得出 3 筆結果</p>
<figure class="highlight js hljs"><figcaption><span>example-3-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"ty"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">95</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">1000</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a1d3d4bede9ac365b25b"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"li"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">94</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">999</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"55f5a1d3d4bede9ac365b25a"</span>) }</span><br><span class="line">{ <span class="hljs-string">"author"</span> : <span class="hljs-string">"dave"</span>, <span class="hljs-string">"score"</span> : <span class="hljs-number">85</span>, <span class="hljs-string">"views"</span> : <span class="hljs-number">521</span> , <span class="hljs-string">"_id"</span> : <span class="title class_">ObjectId</span>(<span class="hljs-string">"512bc962e835e68f199c8687"</span>) }</span><br></pre></td></tr></tbody></table></figure>

<h2 id="常見的資料操作方法（二）"><a href="#常見的資料操作方法（二）" class="headerlink" title="常見的資料操作方法（二）"></a>常見的資料操作方法（二）</h2><p>再來要介紹<code>$project</code>、<code>$unwind</code>、<code>$group</code>這三個方法。</p>
<h3 id="project"><a href="#project" class="headerlink" title="$project"></a><code>$project</code></h3><p><code>$project</code>可以用來篩選或排除 document 已經存在的欄位、也可以用來創造出新的欄位。</p>
<p>假如有一個<code>books</code>collection 資料如下：</p>
<figure class="highlight json hljs"><figcaption><span>books</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span></span><br><span class="line">  title<span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  isbn<span class="hljs-punctuation">:</span> <span class="hljs-string">"0001122223334"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  author<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> last<span class="hljs-punctuation">:</span> <span class="hljs-string">"zzz"</span><span class="hljs-punctuation">,</span> first<span class="hljs-punctuation">:</span> <span class="hljs-string">"aaa"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line">  copies<span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span></span><br><span class="line">  lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2016-07-28"</span></span><br><span class="line"><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span></span><br><span class="line">  title<span class="hljs-punctuation">:</span> <span class="hljs-string">"Baked Goods"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  isbn<span class="hljs-punctuation">:</span> <span class="hljs-string">"9999999999999"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  author<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> last<span class="hljs-punctuation">:</span> <span class="hljs-string">"xyz"</span><span class="hljs-punctuation">,</span> first<span class="hljs-punctuation">:</span> <span class="hljs-string">"abc"</span><span class="hljs-punctuation">,</span> middle<span class="hljs-punctuation">:</span> <span class="hljs-string">""</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line">  copies<span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span></span><br><span class="line">  lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2017-07-21"</span></span><br><span class="line"><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span></span><br><span class="line">  title<span class="hljs-punctuation">:</span> <span class="hljs-string">"Ice Cream Cakes"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  isbn<span class="hljs-punctuation">:</span> <span class="hljs-string">"8888888888888"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  author<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> last<span class="hljs-punctuation">:</span> <span class="hljs-string">"xyz"</span><span class="hljs-punctuation">,</span> first<span class="hljs-punctuation">:</span> <span class="hljs-string">"abc"</span><span class="hljs-punctuation">,</span> middle<span class="hljs-punctuation">:</span> <span class="hljs-string">"mmm"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line">  copies<span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span></span><br><span class="line">  lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2017-07-22"</span></span><br><span class="line"><span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>我們可以用<code>$project</code>來篩選需要的兩個欄位 title、lastModified，並創造出一個新的欄位 authorName。其中的 authorName 用了字串的<code>$concat</code>方法，把 author 的 first name 跟 last name 串連起來：</p>
<figure class="highlight js hljs"><figcaption><span>example-4</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">books</span>.<span class="title function_">aggregate</span>( [</span><br><span class="line">   {</span><br><span class="line">      <span class="hljs-attr">$project</span>: {</span><br><span class="line">         <span class="hljs-attr">title</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// true 表示要留下這個欄位</span></span><br><span class="line">         <span class="hljs-attr">lastModified</span>: <span class="hljs-literal">true</span>,</span><br><span class="line">         <span class="hljs-attr">authorName</span>: { <span class="hljs-comment">// 產生一個新的欄位 authorName</span></span><br><span class="line">           <span class="hljs-attr">$concat</span>: [</span><br><span class="line">             <span class="hljs-string">"$author.first"</span>,</span><br><span class="line">              <span class="hljs-string">' '</span>,</span><br><span class="line">              <span class="hljs-string">"$author.last"</span></span><br><span class="line">              ]</span><br><span class="line">         }</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">] )</span><br></pre></td></tr></tbody></table></figure>
<p>產出結果如下：</p>
<figure class="highlight json hljs"><figcaption><span>example-4-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"title"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span> lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2016-07-28"</span><span class="hljs-punctuation">,</span> authorName<span class="hljs-punctuation">:</span> <span class="hljs-string">"aaa zzz"</span>  <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"title"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"Baked Goods"</span><span class="hljs-punctuation">,</span> lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2017-07-21"</span><span class="hljs-punctuation">,</span> authorName<span class="hljs-punctuation">:</span> <span class="hljs-string">"abc xyz"</span> <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"title"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"Ice Cream Cakes"</span><span class="hljs-punctuation">,</span> lastModified<span class="hljs-punctuation">:</span> <span class="hljs-string">"2017-07-21"</span><span class="hljs-punctuation">,</span> authorName<span class="hljs-punctuation">:</span> <span class="hljs-string">"abc xyz"</span> <span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>值得一提的是<code>_id</code>這個欄位：由於 _id 是 document 的主鍵，除非「特別排除」這個欄位，否則使用<code>$project</code>時預設都會保留下來。如果想要排除 _id，只需要再加上一行<code>_id: false</code>就行～</p>
<h3 id="unwind"><a href="#unwind" class="headerlink" title="$unwind"></a><code>$unwind</code></h3><p><code>$unwind</code>可以把 document 中的陣列資料「攤平」。聽起來好像很抽象，不如直接來看個例子。</p>
<p>假如有一個紀錄產品庫存的<code>inventory</code>collection 資料如下：</p>
<figure class="highlight json hljs"><figcaption><span>inventory</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"shirt"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sizes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span> <span class="hljs-string">"S"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"M"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"L"</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"shoes"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sizes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"M"</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>我們嘗試針對 sizes 這個陣列欄位使用<code>$unwind</code>：</p>
<figure class="highlight js hljs"><figcaption><span>example-5</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">inventory</span>.<span class="title function_">aggregate</span>( [ { <span class="hljs-attr">$unwind</span>: <span class="hljs-string">"$sizes"</span> } ] )</span><br></pre></td></tr></tbody></table></figure>

<p>因為第一筆 document 中 sizes 陣列有三個值，所以攤平後會得到三筆資料。結果如下：</p>
<figure class="highlight js hljs"><figcaption><span>example-5-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-number">1</span>, <span class="hljs-string">"item"</span> : <span class="hljs-string">"shirt"</span>, <span class="hljs-string">"sizes"</span> : <span class="hljs-string">"S"</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-number">1</span>, <span class="hljs-string">"item"</span> : <span class="hljs-string">"shirt"</span>, <span class="hljs-string">"sizes"</span> : <span class="hljs-string">"M"</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-number">1</span>, <span class="hljs-string">"item"</span> : <span class="hljs-string">"shirt"</span>, <span class="hljs-string">"sizes"</span> : <span class="hljs-string">"L"</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-number">2</span>, <span class="hljs-string">"item"</span> : <span class="hljs-string">"shoes"</span>, <span class="hljs-string">"sizes"</span> : <span class="hljs-string">"M"</span> }</span><br></pre></td></tr></tbody></table></figure>

<p><code>$unwind</code>時常放在 pipeline 中間，幫助我們更直觀的處理陣列資料。</p>
<h3 id="group"><a href="#group" class="headerlink" title="$group"></a><code>$group</code></h3><p><code>$group</code>可以把 document 「分組」，還可以根據分組結果做數學運算。是非常好用的工具之一。</p>
<p>假如有一個記錄銷售的<code>sales</code>collection 資料如下：</p>
<figure class="highlight json hljs"><figcaption><span>sales</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"abc"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"2"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2014</span><span class="hljs-number">-03</span><span class="hljs-number">-01</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"jkl"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2014</span><span class="hljs-number">-03</span><span class="hljs-number">-01</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"xyz"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span>  <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2014</span><span class="hljs-number">-03</span><span class="hljs-number">-15</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"xyz"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span>  <span class="hljs-string">"20"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2014</span><span class="hljs-number">-04</span><span class="hljs-number">-04</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"abc"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"10"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2014</span><span class="hljs-number">-04</span><span class="hljs-number">-04</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"def"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2015</span><span class="hljs-number">-06</span><span class="hljs-number">-04</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"def"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"10"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2015</span><span class="hljs-number">-09</span><span class="hljs-number">-10</span><span class="hljs-punctuation">}</span></span><br><span class="line"><span class="hljs-punctuation">{</span> <span class="hljs-attr">"_id"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"item"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"abc"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"quantity"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"5"</span> <span class="hljs-punctuation">,</span> <span class="hljs-attr">"date"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2016</span><span class="hljs-number">-02</span><span class="hljs-number">-06</span><span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>我們使用<code>$group</code>方法，計算出每一個 item 各別賣出了多少數量：</p>
<ul>
<li><code>_id</code>：要做分組的欄位。範例中我們把相同 item 的資料 group 在一組。</li>
<li><code>totalSaleQuantity</code>：我們新加上的欄位。透過<code>$sum</code>把相同 item 的 quantity 相加</li>
</ul>
<figure class="highlight js hljs"><figcaption><span>example-6</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">sales</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  {</span><br><span class="line">    $group : {</span><br><span class="line">       _id : <span class="hljs-string">"$item"</span>, <span class="hljs-comment">// 用 item 欄位做分組</span></span><br><span class="line">       <span class="hljs-attr">totalSaleQuantity</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-string">"$quantity"</span> } <span class="hljs-comment">// 使用 $sum 把同個 item 的 quantity 相加</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"> ])</span><br></pre></td></tr></tbody></table></figure>

<p>得出 4 種不同 item 以及各別賣出的總數量：</p>
<figure class="highlight js hljs"><figcaption><span>example-6-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-string">"abc"</span>, <span class="hljs-string">"totalSaleQuantity"</span> : <span class="hljs-number">17</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-string">"jkl"</span>, <span class="hljs-string">"totalSaleQuantity"</span> : <span class="hljs-number">1</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-string">"xyz"</span>, <span class="hljs-string">"totalSaleQuantity"</span> : <span class="hljs-number">21</span> }</span><br><span class="line">{ <span class="hljs-string">"_id"</span> : <span class="hljs-string">"def"</span>, <span class="hljs-string">"totalSaleQuantity"</span> : <span class="hljs-number">15</span> }</span><br></pre></td></tr></tbody></table></figure>

<p>除了範例裡用的<code>$sum</code>之外，<code>$group</code>還時常搭配<code>$count</code>、<code>$avg</code>、<code>$max</code>等運算符使用。<br>可以在<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/">文件</a>中看到完整的用法。</p>
<h2 id="Aggregation-綜合練習"><a href="#Aggregation-綜合練習" class="headerlink" title="Aggregation 綜合練習"></a>Aggregation 綜合練習</h2><p>我們來試試把多個 stage 組成 pipeline 的綜合練習。</p>
<p>假如有一個訂單的<code>order</code>collection 如下。每筆 order 都包含<code>顧客 id</code>、<code>訂單日期</code>跟<code>金額</code>三個欄位。</p>
<p>我們的目標是找出在 2020 年間，每位顧客的：</p>
<ol>
<li>第一筆訂單時間</li>
<li>訂單的總數</li>
<li>訂單的總金額</li>
</ol>
<figure class="highlight json hljs"><figcaption><span>order</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elise_smith@myemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-05-30T08:35:52Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"231.43"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elise_smith@myemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-01-13T09:32:07Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"99.99"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"oranieri@warmmail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-01-01T08:25:37Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"63.13"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tj@wheresmyemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2019-05-28T19:13:32Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"2.01"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tj@wheresmyemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-11-23T22:56:53Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"187.99"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tj@wheresmyemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-08-18T23:04:48Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"4.59"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elise_smith@myemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-12-26T08:55:46Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"48.50"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tj@wheresmyemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2021-02-29T07:49:32Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"1024.89"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">{</span></span><br><span class="line">  <span class="hljs-attr">"customer_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elise_smith@myemail.com"</span><span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"orderdate"</span><span class="hljs-punctuation">:</span> ISODate(<span class="hljs-string">"2020-10-03T13:49:44Z"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line">  <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> NumberDecimal(<span class="hljs-string">"102.24"</span>)<span class="hljs-punctuation">,</span></span><br><span class="line"><span class="hljs-punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>


<p>首先，我們只需要 2020 年間的訂單，所以可以用<code>$match</code>寫出第一個 stage ：</p>
<figure class="highlight js hljs"><figcaption><span>match</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-string">"$match"</span>: {</span><br><span class="line">    <span class="hljs-string">"orderdate"</span>: {</span><br><span class="line">      <span class="hljs-string">"$gte"</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">"2020-01-01T00:00:00Z"</span>), <span class="hljs-comment">// 時間大於等於 2020/1/1</span></span><br><span class="line">      <span class="hljs-string">"$lt"</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">"2021-01-01T00:00:00Z"</span>), <span class="hljs-comment">// 時間小於 2021/1/1</span></span><br><span class="line">    },</span><br><span class="line">  }</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure>

<p>再來，由於我們要找出「每個使用者」的「第一筆訂單時間」，可以先使用<code>$sort</code>把所有訂單依照日期「由先而後」排序：</p>
<figure class="highlight js hljs"><figcaption><span>sort</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-string">"$sort"</span>: {</span><br><span class="line">    <span class="hljs-string">"orderdate"</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 依照 orderdate 將時間由小而大排序</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>最後，我們使用<code>$group</code>把訂單依照<code>顧客 id</code>做分組，並搭配：</p>
<ul>
<li><code>$first</code>：找出每個顧客的第一筆訂單。因為先前已經 sort 過，所以第一筆訂單就是「時間最早」的訂單</li>
<li><code>$sum</code>：計算出訂單總數、訂單總金額</li>
</ul>
<figure class="highlight js hljs"><figcaption><span>group</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-string">"$group"</span>: {</span><br><span class="line">    <span class="hljs-string">"_id"</span>: <span class="hljs-string">"$customer_id"</span>, <span class="hljs-comment">// 依照 customer_id 做分組</span></span><br><span class="line">    <span class="hljs-string">"first_purchase_date"</span>: {<span class="hljs-string">"$first"</span>: <span class="hljs-string">"$orderdate"</span>}, <span class="hljs-comment">// 找出第一筆（也是最早的） orderdate</span></span><br><span class="line">    <span class="hljs-string">"total_value"</span>: {<span class="hljs-string">"$sum"</span>: <span class="hljs-string">"$value"</span>}, <span class="hljs-comment">// 使用 sum 將每筆 order 的金額加總</span></span><br><span class="line">    <span class="hljs-string">"total_orders"</span>: {<span class="hljs-string">"$sum"</span>: <span class="hljs-number">1</span>}, <span class="hljs-comment">// 使用 sum 計算總共有幾筆 order</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p>我們把上述三個 stage 組裝成 pipeline，對<code>order</code>collection 進行 aggregate 操作：</p>
<figure class="highlight js hljs"><figcaption><span>example-7</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="hljs-property">orders</span>.<span class="title function_">aggregate</span>([</span><br><span class="line">  <span class="hljs-comment">// Match only orders made in 2020</span></span><br><span class="line">  {<span class="hljs-string">"$match"</span>: {</span><br><span class="line">    <span class="hljs-string">"orderdate"</span>: {</span><br><span class="line">      <span class="hljs-string">"$gte"</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">"2020-01-01T00:00:00Z"</span>),</span><br><span class="line">      <span class="hljs-string">"$lt"</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">"2021-01-01T00:00:00Z"</span>),</span><br><span class="line">    },</span><br><span class="line">  }},</span><br><span class="line">  <span class="hljs-comment">// Sort by order date ascending</span></span><br><span class="line">  {<span class="hljs-string">"$sort"</span>: {</span><br><span class="line">    <span class="hljs-string">"orderdate"</span>: <span class="hljs-number">1</span>,</span><br><span class="line">  }},</span><br><span class="line">  <span class="hljs-comment">// Group by customer</span></span><br><span class="line">  {<span class="hljs-string">"$group"</span>: {</span><br><span class="line">    <span class="hljs-string">"_id"</span>: <span class="hljs-string">"$customer_id"</span>,</span><br><span class="line">    <span class="hljs-string">"first_purchase_date"</span>: {<span class="hljs-string">"$first"</span>: <span class="hljs-string">"$orderdate"</span>},</span><br><span class="line">    <span class="hljs-string">"total_value"</span>: {<span class="hljs-string">"$sum"</span>: <span class="hljs-string">"$value"</span>},</span><br><span class="line">    <span class="hljs-string">"total_orders"</span>: {<span class="hljs-string">"$sum"</span>: <span class="hljs-number">1</span>},</span><br><span class="line">  }},</span><br><span class="line">]);</span><br></pre></td></tr></tbody></table></figure>
<p>得出結果：</p>
<figure class="highlight js hljs"><figcaption><span>example-7-result</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-attr">customer_id</span>: <span class="hljs-string">'elise_smith@myemail.com'</span>,</span><br><span class="line">  <span class="hljs-attr">first_purchase_date</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">'2020-01-13T09:32:07.000Z'</span>),</span><br><span class="line">  <span class="hljs-attr">total_value</span>: <span class="title class_">NumberDecimal</span>(<span class="hljs-string">'482.16'</span>),</span><br><span class="line">  <span class="hljs-attr">total_orders</span>: <span class="hljs-number">4</span></span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-attr">customer_id</span>: <span class="hljs-string">'oranieri@warmmail.com'</span>,</span><br><span class="line">  <span class="hljs-attr">first_purchase_date</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">'2020-01-01T08:25:37.000Z'</span>),</span><br><span class="line">  <span class="hljs-attr">total_value</span>: <span class="title class_">NumberDecimal</span>(<span class="hljs-string">'63.13'</span>),</span><br><span class="line">  <span class="hljs-attr">total_orders</span>: <span class="hljs-number">1</span></span><br><span class="line">},</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-attr">customer_id</span>: <span class="hljs-string">'tj@wheresmyemail.com'</span>,</span><br><span class="line">  <span class="hljs-attr">first_purchase_date</span>: <span class="title class_">ISODate</span>(<span class="hljs-string">'2020-08-18T23:04:48.000Z'</span>),</span><br><span class="line">  <span class="hljs-attr">total_value</span>: <span class="title class_">NumberDecimal</span>(<span class="hljs-string">'192.58'</span>),</span><br><span class="line">  <span class="hljs-attr">total_orders</span>: <span class="hljs-number">2</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>如果把<code>CRUD</code>比喻成格鬥遊戲裡的基本攻防招數，那<code>Aggregation</code>就是格鬥遊戲裡的連續技，若能好好善用會是很強大的武器～<br>關於 Aggregation 更詳細的用法可以參考<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/">官方文件</a>與 <a target="_blank" rel="noopener" href="https://www.practical-mongodb-aggregations.com/front-cover.html">Practical MongoDB Aggregations</a> 電子書。</p>
<p>下篇文章我們要介紹能夠加速 mongoDB 效能的 <code>Indexes</code>。</p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/mongodb/">#mongodb</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/database/">#database</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/mongodb-from-scratch/">#mongodb-from-scratch</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/mongodb-%E6%95%99%E5%AD%B8/">#mongodb 教學</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-prev">
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/mongodb-from-scratch/2/">新手到進階學 MongoDB（2）- CRUD 教學</a>
            
        </span>
    </div>
    
</article>


<div class="sharebox">
    
<div class="sharethis-inline-share-buttons"></div>
<script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=60f8d93619c5120013482fe3&amp;product=inline-share-buttons' async='async'></script>

</div>



<div class="comments">
    <h3 class="title is-4">評論</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://www.suki.website/mongodb-from-scratch/3/';
        this.page.identifier = 'mongodb-from-scratch/3/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'suki-website' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2022 Suki Wang&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a
                        target="_blank" rel="noopener" href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" target="_blank" rel="noopener" href="https://github.com/pmc12thsuki">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-tw");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
            display: block;
            overflow-x: auto
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站內搜尋" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '頁面',
                CATEGORIES: '分類',
                TAGS: '標籤',
                UNTITLED: '(無標題)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>